<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Implementing a Priority Queue Using Heapsort in Ruby</title>
  <meta name="description" content="Heaps are a tree data structure that can be implemented using an array. In this case a heap will be a binary min-heap, which means each parent node will be less than the value of each of, at most, two child nodes.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://tbconroy.com/2019/01/02/implementing-a-priority-queue-using-heapsort-in-ruby/">
  
  
  <link rel="alternate" type="application/rss+xml" title="tbconroy" href="http://tbconroy.com/feed.xml">

  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Implementing a Priority Queue Using Heapsort in Ruby">
  <meta name="twitter:description" content="Heaps are a tree data structure that can be implemented using an array. In this case a heap will be a binary min-heap, which means each parent node will be less than the value of each of, at most, ...">
  
  

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet">

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-131654422-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">tbconroy</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="/about/">About</a>
      
        
        <a class="page-link" href="/archives/">Archives</a>
      
        
        <a class="page-link" href="https://github.com/tbconroy">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Implementing a Priority Queue Using Heapsort in Ruby</h1>
    
    <p class="post-meta"><time datetime="2019-01-02T22:07:38+00:00" itemprop="datePublished">Jan 2, 2019</time> â€¢
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/priority-queue/">priority queue</a>,
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/heapsort/">heapsort</a>,
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/algorithms/">algorithms</a>,
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/min-heap/">min-heap</a>,
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/ruby/">ruby</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Heaps are a tree data structure that can be implemented using an array. In this case a heap will be a binary min-heap, which means each parent node will be less than the value of each of, at most, two child nodes.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  3   5
 / \
8   4
</code></pre></div></div>

<p>The above structure can be represented in an array:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
</code></pre></div></div>

<p>Note the first element of the array (i = 0) is <code class="highlighter-rouge">nil</code> to simplify the implementation of the queue (which will be explained below). This element does not represent actual data.</p>

<h2 id="traversing-array-representation-of-a-binary-heap">Traversing Array Representation of a Binary Heap</h2>

<p>To find the index of the left child of a index <code class="highlighter-rouge">i</code> of parent node in the array use <code class="highlighter-rouge">2 * i</code>.</p>

<p>The index of the right child in the array is <code class="highlighter-rouge">(2 * i) + 1</code>.</p>

<p>To find the index of parent for a child of index <code class="highlighter-rouge">j</code> in the array is <code class="highlighter-rouge">j / 2</code>.</p>

<p>The above math works out if the root of the heap starts in the second container of the array, i.e., <code class="highlighter-rouge">i = 1</code>.</p>

<h2 id="initializing-the-heap">Initializing the Heap</h2>

<p>In the ruby implementation the heap in our priority queue is initialized with a dummy <code class="highlighter-rouge">nil</code> value in the first container:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PriorityQueue</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@heap</span> <span class="o">=</span> <span class="p">[</span><span class="kp">nil</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="inserting-values">Inserting Values</h2>

<p>In heapsort the latest value is inserted in the next open leaf node going left to right. For example if <code class="highlighter-rouge">3</code> is inserted into the following heap:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  4   5
 /
8
</code></pre></div></div>

<p>It would result in:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  4   5
 / \
8   3
</code></pre></div></div>

<p>In the array representation this value would simply be inserted at the end:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
<span class="c1"># insert 3</span>
<span class="p">[</span><span class="kp">nil</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></div></div>

<p>Now the heap has to be reordered so each parent is less than its children. This is accomplished be comparing the last inserted value to its parent:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  4   5
 / \
8   3
</code></pre></div></div>

<p>If it is less than its parent then those values are swapped:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  3   5
 / \
8   4
</code></pre></div></div>

<p>This is done recursively up the tree until the it reaches the root or a parent with a value that is less than it.</p>

<p>In ruby this can be implemented like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PriorityQueue</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@heap</span> <span class="o">=</span> <span class="p">[</span><span class="kp">nil</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="vi">@heap</span> <span class="o">&lt;&lt;</span> <span class="n">item</span>
    <span class="n">bubble_up</span><span class="p">(</span><span class="n">last_index</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">bubble_up</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">parent_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="k">if</span> <span class="n">parent_index</span><span class="p">.</span><span class="nf">zero?</span>

    <span class="n">child</span> <span class="o">=</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">parent_index</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">parent</span> <span class="o">&gt;</span> <span class="n">child</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">parent_index</span><span class="p">)</span>
      <span class="n">bubble_up</span><span class="p">(</span><span class="n">parent_index</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">last_index</span>
    <span class="vi">@heap</span><span class="p">.</span><span class="nf">length</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="n">index_a</span><span class="p">,</span> <span class="n">index_b</span><span class="p">)</span>
    <span class="vi">@heap</span><span class="p">[</span><span class="n">index_a</span><span class="p">],</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">index_b</span><span class="p">]</span> <span class="o">=</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">index_b</span><span class="p">],</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">index_a</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="extracting-the-minimum-value">Extracting the Minimum Value</h2>

<p>The root node of the heap represents the minimum value in the queue. Once this value is removed from the queue the next minimum value must occupy the root position.</p>

<p>Starting with this initial heap:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    1
   / \
  3   5
 / \
8   9
</code></pre></div></div>

<p>The root node and the last right-most node are swapped:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    9
   / \
  3   5
 / \
8   1
</code></pre></div></div>

<p>Then the last right-most node is removed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    9
   / \
  3   5
 /
8
</code></pre></div></div>

<p>Then the heap is reordered by comparing the root note to its smallest child and swapping them if the root is greater than that child:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    3
   / \
  9   5
 /
8
</code></pre></div></div>

<p>The the newly swapped child from the last operation is then compared to its smallest child and then again swapped if it is greater than that child. This is done recursively downward until the bottom-most node is reached or the child is greater than the parent:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    3
   / \
  8   5
 /
9
</code></pre></div></div>

<p>This can be implemented in ruby by extending the <code class="highlighter-rouge">PriorityQueue</code> class from above. Here the method <code class="highlighter-rouge">next</code> is added which returns the minimum value in the queue and reorders the heap:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PriorityQueue</span>
  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">next</span>
    <span class="n">minimum</span> <span class="o">=</span> <span class="vi">@heap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">swap</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_index</span><span class="p">)</span>
    <span class="vi">@heap</span><span class="p">.</span><span class="nf">pop</span>
    <span class="n">bubble_down</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">minimum</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">bubble_down</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="n">left_child_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">right_child_index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="k">if</span> <span class="n">left_child_index</span> <span class="o">&gt;</span> <span class="n">last_index</span>

    <span class="n">lesser_child_index</span> <span class="o">=</span> <span class="n">determine_lesser_child</span><span class="p">(</span><span class="n">left_child_index</span><span class="p">,</span> <span class="n">right_child_index</span><span class="p">)</span>

    <span class="k">if</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">lesser_child_index</span><span class="p">]</span>
      <span class="n">swap</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">lesser_child_index</span><span class="p">)</span>
      <span class="n">bubble_down</span><span class="p">(</span><span class="n">lesser_child_index</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">determine_lesser_child</span><span class="p">(</span><span class="n">left_child_index</span><span class="p">,</span> <span class="n">right_child_index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left_child_index</span> <span class="k">if</span> <span class="n">right_child_index</span> <span class="o">&gt;</span> <span class="n">last_index</span>

    <span class="k">if</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">left_child_index</span><span class="p">]</span> <span class="o">&lt;</span> <span class="vi">@heap</span><span class="p">[</span><span class="n">right_child_index</span><span class="p">]</span>
      <span class="n">left_child_index</span>
    <span class="k">else</span>
      <span class="n">right_child_index</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>Here is an example of how this class would be used:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pq</span> <span class="o">=</span> <span class="no">PriorityQueue</span><span class="p">.</span><span class="nf">new</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;PriorityQueue:0x00007ffa21145050 @heap=[nil]&gt;</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;PriorityQueue:0x00007ffa21145050 @heap=[nil, 100]&gt;</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;PriorityQueue:0x00007ffa21145050 @heap=[nil, 1, 100]&gt;</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;PriorityQueue:0x00007ffa21145050 @heap=[nil, 1, 100, 50]&gt;</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="mi">1</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="mi">50</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="mi">100</span>
<span class="n">pq</span><span class="p">.</span><span class="nf">next</span>
<span class="o">=&gt;</span> <span class="kp">nil</span>
</code></pre></div></div>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; Tom Conroy - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="http://tbconroy.com/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
